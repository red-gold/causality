!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("causal-net.utils"),require("causal-net.core"),require("causal-net.storage"),require("causal-net.memcache"),require("@tensorflow-models/universal-sentence-encoder")):"function"==typeof define&&define.amd?define(["causal-net.utils","causal-net.core","causal-net.storage","causal-net.memcache","@tensorflow-models/universal-sentence-encoder"],t):"object"==typeof exports?exports["@causalNet/representation"]=t(require("causal-net.utils"),require("causal-net.core"),require("causal-net.storage"),require("causal-net.memcache"),require("@tensorflow-models/universal-sentence-encoder")):e["@causalNet/representation"]=t(e["causal-net.utils"],e["causal-net.core"],e["causal-net.storage"],e["causal-net.memcache"],e["@tensorflow-models/universal-sentence-encoder"])}(this,function(e,t,n,r,i){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,n){"use strict";(function(e){var r=n(6),i=n(0),s=n(1);t.a=new class extends(i.Platform.mixWith(s.Tensor,[])){constructor(){super(),this.use=r,this.model=null}async connect(){return e&&(e.fetch=i.Fetch.fetch),this.model=await this.use.load(),this}async sentenceEncode(e){if(!this.model)throw Error("model is not connect");return await this.model.embed(e)}}}).call(this,n(8))},function(e,t,n){var r=n(7);e.exports=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){r(e,t,n[t])})}return e}},function(e,t){e.exports=i},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";n.r(t);var r=n(1),i=n(0);var s=e=>(class extends e{get Representation(){if(!this.representation)throw Error("representation is not set");return this.representation}set Representation(e){i.Assert.beInstanceOf(e,r.Tensor),this.representation=e}async connect(){super.connect&&super.connect();let e=this.embeddingConfig;this.logger.log(`representation connect to ${e}`),await this.Representation.connect(e)}setRepresentationByConfig(e){let{EmbeddingConfig:t,Embedding:n}=e.Representation;i.Assert.beInstanceOf(t,String),this.Representation=n,this.embeddingConfig=t}}),o=n(2),a=n(3),c=n(5),u=n.n(c);var h=e=>(class extends e{unknowVec(){return this.F.zeroVec(this.VecSize)}async sentenceEncode(e){const t=this.T;let n=[];for(let r of e){let e=await this.transform(r),i=await t.tensor(e).mean(0);n.push(i)}return t.stack(n)}async transform(e){const t=this.TokenLookUp,n=this.ChunkLookUp;let r=[],i=[];for(let n of e){let e=await t(n);this.logger.debug({[n]:e}),null===e&&(i=[...i,n]),r=[...r,n]}if(0===i.length)return r;let{tokenChunkIds:s,chunkIds:o}=this.F.mapTokenToChunkIds(i,this.TokenChunkIdMapper);this.logger.debug({tokenChunkIds:s,chunkIds:o});let a={};for(let e of o)if(null!==e){console.log("lookup");let t=await n(e);null===t&&(t=await this.queryChunk(e),await this.updateChunkLookUp(e,t)),a=u()({},a,t)}return r.reduce((e,t)=>{if("string"==typeof t){let n=a[t];void 0===n&&(n=this.unknowVec()),e.push(n)}else e.push(t);return e},[])}});var l=e=>(class extends e{get ChunkLookUp(){const e=this.Storage;return t=>new Promise(async(n,r)=>{try{const r=this.embeddingSavePath+t;let i=(await e.getItem(r))[r];n(JSON.parse(i))}catch(e){n(null)}})}async updateChunkLookUp(e,t){const n=this.Storage,r=this.embeddingSavePath+e;return await n.setItem(r,t)}async queryChunk(e){const t=`${this.baseLink}wordvec_chunk_${e}.json`;return await this.query(t)}});var d=e=>(class extends e{get TokenLookUp(){const e=this.MemCache;return t=>new Promise(async(n,r)=>{try{n(await e.getItem(this.embeddingSavePath+t))}catch(e){n(null)}})}async updateTokenLookUp(e,t){console.error("this is update");const n=this.MemCache;await n.setItem(this.embeddingSavePath+e,t)}});var p=e=>(class extends e{mapTokenToChunkIds(e,t){const n=this.R,r=t;let i=e.map(e=>{let t=r(e);return[[e,t],t]}),[s,o]=this.unzip(i),a=n.uniq(o);return console.log({chunkIds:a,tokenChunkIds:s}),{tokenChunkIds:s,chunkIds:a}}zeroVec(e){return this.R.map(()=>0,this.R.range(0,e))}});class f extends(i.Platform.mixWith(r.Function,[p])){constructor(){super()}}var g=new class extends(i.Platform.mixWith(r.Tensor,[o.StorageMixins,a.MemCacheMixins,d,l,h])){constructor(){super(),this.Fetch=i.Fetch,this.Storage=o.indexDBStorage,this.MemCache=a.memDownCache,this.F=new f,this.embeddingSavePath="/embedding/",this.embeddingDescriptionPath=this.embeddingSavePath+"description.json"}get VecSize(){if(!this.vecsize)throw Error("vecsize is not set");return this.vecsize}async connect(e,t=!1){return this.baseLink=e,await this.getDescription(t)}async getDescription(e=!1){if(!this.description)try{let e=await this.Storage.getItem(this.embeddingDescriptionPath);this.description=JSON.parse(e[this.embeddingDescriptionPath])}catch(e){this.logger.debug({"load description from storage":!1}),this.description=await this.queryDescription()}return e&&(this.description=await this.queryDescription()),this.TokenChunkIdMapper=(e=>this.F.getIn([e],this.description.chunkLookUp,null)),this.vecsize=this.description.vecsize,this.description}async query(e){return e.startsWith("http")?await i.JSONUtils.fetchJson(e):await i.JSONUtils.readJSON(e)}async queryDescription(){const e=this.baseLink+"wordvec.description.json";this.logger.debug({DescriptionLink:e});var t=this.query(e);return await this.Storage.setItem(this.embeddingDescriptionPath,JSON.stringify(t)),this.description=t,this.description}},m=n(4);n.d(t,"RepresentationMixins",function(){return s}),n.d(t,"causalNetEmbedding",function(){return g}),n.d(t,"universalEmbedding",function(){return m.a}),n.d(t,"WordEmbeddingMixins",function(){return h}),n.d(t,"ChunkLookupMixins",function(){return l}),n.d(t,"TokenLookUpMixins",function(){return d}),n.d(t,"WordEmbeddingFunctionMixins",function(){return p})}])});
//# sourceMappingURL=representation.node.js.map